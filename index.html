<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>รับการแจ้งเตือน RakmaoEZY ผ่าน LINE</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap');
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --app-font: 'Prompt', 'Noto Sans Thai', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            --primary-color: #00c851;
            --primary-dark: #00a844;
            --error-color: #dc3545;
            --error-dark: #c82333;
        }
        
        html, body {
            font-family: var(--app-font) !important;
        }
        
        body {
            background: #f3f4f6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        button, input, select, textarea {
            font-family: var(--app-font) !important;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
            text-align: center;
            animation: containerFadeIn 0.4s ease-out;
        }
        
        @keyframes containerFadeIn {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        /* Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Messages */
        .message {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .message.error {
            color: var(--error-color);
            font-weight: 500;
        }
        
        .message.success {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        /* Status Box */
        .status-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            color: #333;
            border-left: 4px solid var(--primary-color);
        }
        
        /* Buttons */
        .btn {
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 18px;
            font-weight: 500;
            transition: all 0.3s;
            font-family: var(--app-font) !important;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            padding: 15px 30px;
            margin-bottom: 15px;
            animation: buttonPulse 2s ease-in-out infinite;
        }
        
        @keyframes buttonPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 200, 81, 0.4);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(0, 200, 81, 0);
            }
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,200,81,0.3);
            animation: none;
        }
        
        .btn-secondary {
            background: transparent;
            color: #666;
            padding: 12px 25px;
            border: 2px solid #ddd;
        }
        
        .btn-secondary:hover:not(:disabled) {
            border-color: #999;
            color: #333;
        }
        
        /* ==================== SVG ICONS ==================== */
        .icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        /* Success Icon */
        .success-icon {
            width: 80px;
            height: 80px;
        }
        
        .success-icon .circle {
            fill: none;
            stroke: var(--primary-color);
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 226;
            stroke-dashoffset: 226;
            animation: circle-draw 0.6s ease-out forwards;
            transform-origin: center;
        }
        
        .success-icon .check {
            fill: none;
            stroke: var(--primary-color);
            stroke-width: 5;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 50;
            stroke-dashoffset: 50;
            animation: check-draw 0.4s ease-out 0.4s forwards;
        }
        
        @keyframes circle-draw {
            to {
                stroke-dashoffset: 0;
            }
        }
        
        @keyframes check-draw {
            to {
                stroke-dashoffset: 0;
            }
        }
        
        /* Success pulse effect */
        .success-icon .pulse {
            fill: none;
            stroke: var(--primary-color);
            stroke-width: 2;
            opacity: 0;
            animation: pulse-ring 1s ease-out 0.8s forwards;
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(1);
                opacity: 0.6;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }
        
        /* Error Icon */
        .error-icon {
            width: 80px;
            height: 80px;
        }
        
        .error-icon .circle {
            fill: none;
            stroke: var(--error-color);
            stroke-width: 4;
            stroke-linecap: round;
            stroke-dasharray: 226;
            stroke-dashoffset: 226;
            animation: circle-draw 0.6s ease-out forwards;
        }
        
        .error-icon .x-line {
            fill: none;
            stroke: var(--error-color);
            stroke-width: 5;
            stroke-linecap: round;
            stroke-dasharray: 30;
            stroke-dashoffset: 30;
        }
        
        .error-icon .x-line-1 {
            animation: x-draw 0.3s ease-out 0.4s forwards;
        }
        
        .error-icon .x-line-2 {
            animation: x-draw 0.3s ease-out 0.55s forwards;
        }
        
        @keyframes x-draw {
            to {
                stroke-dashoffset: 0;
            }
        }
        
        /* Error shake effect */
        .error-icon.animate {
            animation: shake 0.5s ease-out 0.7s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }
        
        /* Manual Close Text */
        .manual-close-text {
            color: #666;
            font-size: 14px;
            margin-top: 15px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading View -->
        <div id="loadingView" class="view active">
            <div class="spinner"></div>
            <div id="loadingMessage" class="message">กำลังเชื่อมต่อกับ LINE...</div>
        </div>
        
        <!-- Processing View -->
        <div id="processingView" class="view">
            <div class="spinner"></div>
            <div id="processingMessage" class="message">กำลังเชื่อมต่อข้อมูล...</div>
            <div id="statusBox" class="status-box" style="display:none;"></div>
        </div>
        
        <!-- Success View -->
        <div id="successView" class="view">
            <div class="icon-wrapper">
                <svg class="success-icon" viewBox="0 0 80 80">
                    <circle class="pulse" cx="40" cy="40" r="36"/>
                    <circle class="circle" cx="40" cy="40" r="36"/>
                    <path class="check" d="M24 42 L34 52 L56 30"/>
                </svg>
            </div>
            <div class="message success">
                เชื่อมต่อข้อมูลสำเร็จแล้ว!
            </div>
            <div id="successMessage" class="message">
                กำลังปิดหน้านี้...
            </div>
            <div id="manualCloseText" class="manual-close-text" style="display:none;">
                กรุณากดปุ่ม X ด้านบนขวาเพื่อปิดหน้านี้
            </div>
        </div>
        
        <!-- Error View -->
        <div id="errorView" class="view">
            <div class="icon-wrapper">
                <svg class="error-icon animate" viewBox="0 0 80 80">
                    <circle class="circle" cx="40" cy="40" r="36"/>
                    <line class="x-line x-line-1" x1="28" y1="28" x2="52" y2="52"/>
                    <line class="x-line x-line-2" x1="52" y1="28" x2="28" y2="52"/>
                </svg>
            </div>
            <div id="errorMessage" class="message error"></div>
            <button id="retryBtn" class="btn btn-primary" style="display:none;">
                ลองใหม่อีกครั้ง
            </button>
            <button id="closeBtn" class="btn btn-secondary" style="margin-top:10px;">
                ปิดหน้านี้
            </button>
        </div>
    </div>
    
    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            LIFF_ID: '2008146540-V1XjpJp4',
            GLIDE_API_URL: 'https://api.glideapp.io/api/function/mutateTables',
            GLIDE_API_TOKEN: 'Bearer ac38ea2f-fc70-4c94-a2c8-7a57783484e4',
            GLIDE_APP_ID: 'wFtUtanipzHwHsjbHCij',
            GLIDE_TABLE_NAME: 'native-table-Iaj8OYHgkSlTKB831ukh',
            API_TIMEOUT: 15000,
            INIT_TIMEOUT: 3000,
            ROWID_MAX_AGE: 86400000, // 24 ชั่วโมง
            MIN_LOGIN_INTERVAL: 5000
        };
        
        // ==================== GLOBAL STATE ====================
        let state = {
            userProfile: null,
            rowId: null,
            isLoggingIn: false,
            isProcessing: false,
            lastLoginAttempt: 0
        };
        
        // ==================== VIEW MANAGEMENT ====================
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
        }
        
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            showView('loadingView');
        }
        
        function showProcessing(message) {
            document.getElementById('processingMessage').textContent = message;
            document.getElementById('statusBox').style.display = 'none';
            showView('processingView');
        }
        
        function updateProcessingStatus(message) {
            const statusBox = document.getElementById('statusBox');
            statusBox.textContent = message;
            statusBox.style.display = 'block';
        }
        
        function showSuccess(message = 'กำลังปิดหน้านี้...') {
            document.getElementById('successMessage').textContent = message;
            showView('successView');
        }
        
        function showError(message, showRetry = false) {
            document.getElementById('errorMessage').innerHTML = message.replace(/\n/g, '<br>');
            document.getElementById('retryBtn').style.display = showRetry ? 'block' : 'none';
            showView('errorView');
        }
        
        // ==================== COMPLETION FLAG ====================
        function markAsCompleted() {
            try {
                sessionStorage.setItem('liff_completed', 'true');
                sessionStorage.setItem('liff_completed_time', Date.now().toString());
            } catch (e) {
                console.error('Failed to mark as completed:', e);
            }
        }
        
        function isAlreadyCompleted() {
            try {
                const completed = sessionStorage.getItem('liff_completed');
                const completedTime = parseInt(sessionStorage.getItem('liff_completed_time') || '0');
                const age = Date.now() - completedTime;
                
                return completed === 'true' && age < 300000; // 5 นาที
            } catch (e) {
                return false;
            }
        }
        
        function clearCompletedFlag() {
            try {
                sessionStorage.removeItem('liff_completed');
                sessionStorage.removeItem('liff_completed_time');
            } catch (e) {
                // Ignore
            }
        }
        
        // ==================== ROWID MANAGEMENT ====================
        function saveRowId(rowid) {
            if (!rowid) return;
            
            try {
                const timestamp = Date.now();
                sessionStorage.setItem('saved_rowid', rowid);
                sessionStorage.setItem('rowid_timestamp', timestamp.toString());
                localStorage.setItem('saved_rowid', rowid);
                localStorage.setItem('rowid_timestamp', timestamp.toString());
            } catch (e) {
                console.error('Failed to save rowid:', e);
            }
        }
        
        function retrieveRowId() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 1. จาก URL query parameter โดยตรง
            let rowid = urlParams.get('rowid');
            if (rowid && validateRowId(rowid).valid) {
                console.log('Found rowid in URL:', rowid);
                return rowid;
            }
            
            // 2. จาก liff.state
            const liffState = urlParams.get('liff.state');
            if (liffState) {
                try {
                    const stateParams = new URLSearchParams(liffState);
                    rowid = stateParams.get('rowid');
                    if (rowid && validateRowId(rowid).valid) {
                        console.log('Found rowid in liff.state:', rowid);
                        return rowid;
                    }
                    
                    if (liffState.includes('rowid=')) {
                        const match = liffState.match(/rowid=([^&]+)/);
                        if (match && match[1]) {
                            rowid = decodeURIComponent(match[1]);
                            if (validateRowId(rowid).valid) {
                                console.log('Found rowid in liff.state (regex):', rowid);
                                return rowid;
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error parsing liff.state:', e);
                }
            }
            
            // 3. จาก sessionStorage
            rowid = sessionStorage.getItem('saved_rowid');
            if (rowid && isRowIdFresh('session') && validateRowId(rowid).valid) {
                console.log('Found rowid in sessionStorage:', rowid);
                return rowid;
            }
            
            // 4. จาก localStorage
            rowid = localStorage.getItem('saved_rowid');
            if (rowid && isRowIdFresh('local') && validateRowId(rowid).valid) {
                console.log('Found rowid in localStorage:', rowid);
                return rowid;
            }
            
            console.log('No valid rowid found');
            return null;
        }
        
        function isRowIdFresh(storageType) {
            try {
                const storage = storageType === 'session' ? sessionStorage : localStorage;
                const timestamp = parseInt(storage.getItem('rowid_timestamp') || '0');
                const age = Date.now() - timestamp;
                return age < CONFIG.ROWID_MAX_AGE;
            } catch (e) {
                return false;
            }
        }
        
        function validateRowId(rowid) {
            if (!rowid) {
                return {
                    valid: false,
                    error: 'ไม่พบข้อมูลการเชื่อมต่อ\n\nกรุณาเปิดลิงก์จากระบบอีกครั้ง'
                };
            }
            
            if (typeof rowid !== 'string' || rowid.length < 10) {
                return {
                    valid: false,
                    error: 'รูปแบบข้อมูลไม่ถูกต้อง\n\nกรุณาเปิดลิงก์จากระบบอีกครั้ง'
                };
            }
            
            return { valid: true };
        }
        
        function updateUrlWithRowId(rowid) {
            if (!rowid) return;
            
            try {
                const url = new URL(window.location.href);
                url.searchParams.set('rowid', rowid);
                url.searchParams.delete('liff.state');
                url.searchParams.delete('liff.referrer');
                window.history.replaceState({}, '', url.toString());
            } catch (e) {
                console.error('Failed to update URL:', e);
            }
        }
        
        // ==================== LIFF LOGIN ====================
        async function handleLoginState() {
            try {
                if (isAlreadyCompleted()) {
                    showSuccess('เชื่อมต่อข้อมูลสำเร็จแล้ว!');
                    setTimeout(() => {
                        closeWindow();
                    }, 1000);
                    return false;
                }
                
                if (state.isLoggingIn) {
                    return false;
                }
                
                if (!liff._initialized) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                const isLoggedIn = liff.isLoggedIn();
                
                if (!isLoggedIn) {
                    const timeSinceLastAttempt = Date.now() - state.lastLoginAttempt;
                    
                    if (timeSinceLastAttempt < CONFIG.MIN_LOGIN_INTERVAL) {
                        showError(
                            'ไม่สามารถเข้าสู่ระบบได้\n\n' +
                            'กรุณาลองเปิดลิงก์นี้ใน LINE app โดยตรง\n' +
                            'หรือใช้ Google Chrome',
                            false
                        );
                        return false;
                    }
                    
                    const rowid = retrieveRowId();
                    const validation = validateRowId(rowid);
                    
                    if (!validation.valid) {
                        showError(validation.error, false);
                        return false;
                    }
                    
                    saveRowId(rowid);
                    state.rowId = rowid;
                    
                    state.isLoggingIn = true;
                    state.lastLoginAttempt = Date.now();
                    sessionStorage.setItem('last_login_attempt', state.lastLoginAttempt.toString());
                    
                    showLoading('กำลังเปิด LINE เพื่อยืนยันตัวตน...');
                    
                    const redirectUrl = new URL(window.location.origin + window.location.pathname);
                    redirectUrl.searchParams.set('rowid', state.rowId);
                    
                    liff.login({ redirectUri: redirectUrl.toString() });
                    
                    return false;
                }
                
                state.isLoggingIn = false;
                
                const rowid = retrieveRowId();
                const validation = validateRowId(rowid);
                
                if (!validation.valid) {
                    showError(validation.error, false);
                    return false;
                }
                
                state.rowId = rowid;
                updateUrlWithRowId(rowid);
                
                // ดึงโปรไฟล์ แล้วส่งเข้า Glide ทันที
                showLoading('กำลังดึงข้อมูลจาก LINE...');
                const profile = await liff.getProfile();
                state.userProfile = profile;
                
                await sendToGlideAPI();
                return true;
                
            } catch (error) {
                state.isLoggingIn = false;
                throw error;
            }
        }
        
        // ==================== GLIDE API ====================
        async function sendToGlideAPI() {
            if (state.isProcessing) {
                return;
            }
            
            state.isProcessing = true;
            
            try {
                if (!state.userProfile || !state.rowId) {
                    throw new Error('ไม่พบข้อมูลที่จำเป็น');
                }
                
                showProcessing('กำลังส่งข้อมูล...');
                
                const payload = {
                    appID: CONFIG.GLIDE_APP_ID,
                    mutations: [{
                        kind: "set-columns-in-row",
                        tableName: CONFIG.GLIDE_TABLE_NAME,
                        columnValues: {
                            "hbHy1": state.userProfile.userId || '',
                            "7TucJ": state.userProfile.displayName || '',
                            "rzbcg": state.userProfile.pictureUrl || ''
                        },
                        rowID: state.rowId
                    }]
                };
                
                updateProcessingStatus('กำลังเชื่อมต่อกับระบบ...');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), CONFIG.API_TIMEOUT);
                
                const response = await fetch(CONFIG.GLIDE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': CONFIG.GLIDE_API_TOKEN
                    },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`การเชื่อมต่อล้มเหลว (${response.status})`);
                }
                
                const result = await response.json();
                
                markAsCompleted();
                showSuccess();
                
                setTimeout(() => {
                    closeWindow();
                }, 1500);
                
            } catch (error) {
                state.isProcessing = false;
                
                let errorMessage = 'เกิดข้อผิดพลาดในการเชื่อมต่อ\n\n';
                
                if (error.name === 'AbortError') {
                    errorMessage += 'การเชื่อมต่อใช้เวลานานเกินไป\nกรุณาตรวจสอบสัญญาณอินเทอร์เน็ต';
                } else if (error.message) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'กรุณาลองใหม่อีกครั้ง';
                }
                
                showError(errorMessage, true);
            }
        }
        
        // ==================== WINDOW CLOSING ====================
        function closeWindow() {
            // ปิดผ่าน LIFF (ใน LINE)
            try {
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    liff.closeWindow();
                }
            } catch (e) {
                console.error('LIFF close failed:', e);
            }
            
            // ปิดผ่าน window.close (กรณีเปิดจาก window.open)
            try {
                window.close();
            } catch (e) {
                console.error('window.close failed:', e);
            }
            
            // ถ้ายังไม่ปิด ให้แสดงข้อความให้ผู้ใช้กดปิดเอง
            setTimeout(() => {
                if (!document.hidden) {
                    showManualClose();
                }
            }, 1500);
        }
        
        function showManualClose() {
            document.getElementById('successMessage').textContent = 'กรุณาปิดหน้าต่างนี้';
            document.getElementById('manualCloseText').style.display = 'block';
        }
        
        // ==================== SESSION CLEANUP ====================
        function cleanupSession() {
            try {
                sessionStorage.removeItem('pwa_login_redirect');
                sessionStorage.removeItem('last_login_attempt');
            } catch (e) {
                // Ignore
            }
        }
        
        // ==================== LIFF INITIALIZATION ====================
        async function initializeLiff() {
            try {
                if (isAlreadyCompleted()) {
                    showSuccess('เชื่อมต่อข้อมูลสำเร็จแล้ว!');
                    setTimeout(() => {
                        closeWindow();
                    }, 1000);
                    return;
                }
                
                showLoading('กำลังเตรียมระบบ...');
                
                if (typeof liff === 'undefined') {
                    throw new Error('ไม่สามารถโหลดระบบได้\n\nกรุณาลองใหม่อีกครั้ง');
                }
                
                const initPromise = liff.init({ liffId: CONFIG.LIFF_ID });
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('TIMEOUT')), CONFIG.INIT_TIMEOUT)
                );
                
                await Promise.race([initPromise, timeoutPromise]);
                await new Promise(resolve => setTimeout(resolve, 500));
                await handleLoginState();
                
            } catch (error) {
                let errorMessage = 'ไม่สามารถเชื่อมต่อได้\n\n';
                
                if (error.message === 'TIMEOUT') {
                    errorMessage += 'การเชื่อมต่อใช้เวลานานเกินไป\nกรุณาลองใหม่อีกครั้ง';
                } else {
                    errorMessage += error.message || 'เกิดข้อผิดพลาด';
                }
                
                showError(errorMessage, true);
            }
        }
        
        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('retryBtn').addEventListener('click', function() {
                clearCompletedFlag();
                if (state.userProfile && state.rowId) {
                    sendToGlideAPI();
                } else {
                    window.location.reload();
                }
            });
            
            document.getElementById('closeBtn').addEventListener('click', function() {
                closeWindow();
            });
            
            initializeLiff();
        });
        
        window.addEventListener('beforeunload', cleanupSession);
        window.addEventListener('pagehide', cleanupSession);
        
        window.addEventListener('error', function(e) {
            console.error('Global Error:', e.error);
        });
    </script>
</body>
</html>
